INSERT INTO DDWH02_DM_MA.TFCT_BARE_BACKLOG_RECEPTION TRG (BARE_CD_PLANT_CD, BARE_ID_BARE, BARE_ID_TIME_INV_DT, BARE_ID_VEND_ID, BARE_CD_VENDOR, BARE_ID_MTRL_MATERIAL, BARE_CD_MATERIAL, BARE_CD_MATERIAL_PURCH_TP, BARE_ID_MASP_MAT_SUPP_REL, BARE_ID_TIME_REQ_DLVR_DT, BARE_CD_PURCH_ORG_CD, BARE_CD_INFO_REC_CAT, BARE_CD_PURCH_ORD, BARE_CD_PURCH_ORD_LN, BARE_QT_TOTAL_ORD_PAST, BARE_QT_POLN_REQ_QTY, BARE_QT_POLN_CUM_REC_QTY, BARE_QT_POLN_REM_QTY, BARE_ID_TIME_LAST_RECEPT_DT, BARE_CD_SEQ_ID, BARE_ID_TIME_FIRST_REQ_SHIP_DT, BARE_ID_TIME_DUE_ON_DOCK_DT, BARE_QT_SCLN_REQ_QTY, BARE_QT_SCLN_CUM_REC_QTY, BARE_QT_SCLN_REM_REQ_QTY, BARE_QT_SCLN_DELAY_WRK_DAYS, BARE_CD_RELEASE_NUMBER_CSCN, BARE_ID_TIME_RELEASE_DT_CSCN, BARE_DT_RELEASE_DT_CSCN, BARE_QT_REQ_QTY_CSCN, BARE_QT_CUM_REQ_QTY_CSCN, BARE_QT_CUM_REC_QTY_CSCN, BARE_QT_TRANSIT_QTY_CSCN, BARE_QT_CUM_PUR_QTY_CSCN, BARE_QT_BALANCE_QTY_CSCN, BARE_CD_LAST_REC_PACKLIST_CSCN, BARE_CD_LAST_ASN_PACKLIST_CSCN, BARE_CD_LAST_PICKUP_REQID_CSCN, BARE_ID_BATCH_ID, BARE_CD_SOURCE_SYSTEM, BARE_DT_INS_ROW, BARE_DT_UPD_ROW, BARE_CD_OPERATOR_CODE)
SELECT QRY.BARE_CD_PLANT_CD,
       QRY.BARE_ID_BARE,
       QRY.BARE_ID_TIME_INV_DT,
       QRY.BARE_ID_VEND_ID,
       QRY.BARE_CD_VENDOR,
       QRY.BARE_ID_MTRL_MATERIAL,
       QRY.BARE_CD_MATERIAL,
       QRY.BARE_CD_MATERIAL_PURCH_TP,
       QRY.BARE_ID_MASP_MAT_SUPP_REL,
       QRY.BARE_ID_TIME_REQ_DLVR_DT,
       QRY.BARE_CD_PURCH_ORG_CD,
       QRY.BARE_CD_INFO_REC_CAT,
       QRY.BARE_CD_PURCH_ORD,
       QRY.BARE_CD_PURCH_ORD_LN,
       QRY.BARE_QT_TOTAL_ORD_PAST,
       QRY.BARE_QT_POLN_REQ_QTY,
       QRY.BARE_QT_POLN_CUM_REC_QTY,
       QRY.BARE_QT_POLN_REM_QTY,
       QRY.BARE_ID_TIME_LAST_RECEPT_DT,
       QRY.BARE_CD_SEQ_ID,
       QRY.BARE_ID_TIME_FIRST_REQ_SHIP_DT,
       QRY.BARE_ID_TIME_DOD_DT,
       QRY.BARE_QT_SCLN_REQ_QTY,
       QRY.BARE_QT_SCLN_CUM_REC_QTY,
       QRY.BARE_QT_SCLN_REM_REQ_QTY,
       QRY.BARE_QT_SCLN_DELAY_WRK_DAYS,
       QRY.BARE_CD_RELEASE_NUMBER_CSCN,
       QRY.BARE_ID_TIME_RELEASE_DT_CSCN,
       QRY.BARE_DT_RELEASE_DT_CSCN,
       QRY.BARE_QT_REQ_QTY_CSCN,
       QRY.BARE_QT_CUM_REQ_QTY_CSCN,
       QRY.BARE_QT_CUM_REC_QTY_CSCN,
       QRY.BARE_QT_TRANSIT_QTY_CSCN,
       QRY.BARE_QT_CUM_PUR_QTY_CSCN,
       QRY.BARE_QT_BALANCE_QTY_CSCN,
       QRY.BARE_CD_LAST_REC_PACKLIST_CSCN,
       QRY.BARE_CD_LAST_ASN_PACKLIST_CSCN,
       QRY.BARE_CD_LAST_PICKUP_REQID_CSCN,
       QRY.BARE_ID_BATCH_ID,
       QRY.BARE_CD_SOURCE_SYSTEM,
       SYSDATE,
       SYSDATE,
       'ETL'
FROM
  (SELECT BARE_CD_PLANT_CD,
          BARE_ID_BARE,
          BARE_ID_TIME_INV_DT,
          BARE_ID_VEND_ID,
          BARE_CD_VENDOR,
          BARE_ID_MTRL_MATERIAL,
          BARE_CD_MATERIAL,
          BARE_CD_MATERIAL_PURCH_TP,
          BARE_ID_MASP_MAT_SUPP_REL,
          BARE_ID_TIME_REQ_DLVR_DT,
          BARE_CD_PURCH_ORG_CD,
          BARE_CD_INFO_REC_CAT,
          BARE_CD_PURCH_ORD,
          BARE_CD_PURCH_ORD_LN,
          BARE_QT_TOTAL_ORD_PAST,
          BARE_QT_POLN_REQ_QTY,
          BARE_QT_POLN_CUM_REC_QTY,
          BARE_QT_POLN_REM_QTY,
          BARE_ID_TIME_LAST_RECEPT_DT,
          BARE_CD_SEQ_ID,
          BARE_ID_TIME_FIRST_REQ_SHIP_DT,
          BARE_ID_TIME_DOD_DT,
          BARE_QT_SCLN_REQ_QTY,
          BARE_QT_SCLN_CUM_REC_QTY,
          BARE_QT_SCLN_REM_REQ_QTY,
          BARE_QT_SCLN_DELAY_WRK_DAYS,
          BARE_CD_RELEASE_NUMBER_CSCN,
          BARE_ID_TIME_RELEASE_DT_CSCN,
          BARE_DT_RELEASE_DT_CSCN,
          BARE_QT_REQ_QTY_CSCN,
          BARE_QT_CUM_REQ_QTY_CSCN,
          BARE_QT_CUM_REC_QTY_CSCN,
          BARE_QT_TRANSIT_QTY_CSCN,
          BARE_QT_CUM_PUR_QTY_CSCN,
          BARE_QT_BALANCE_QTY_CSCN,
          BARE_CD_LAST_REC_PACKLIST_CSCN,
          BARE_CD_LAST_ASN_PACKLIST_CSCN,
          BARE_CD_LAST_PICKUP_REQID_CSCN,
          NVL (P_ELT_ID_BATCH, N_ELT_ID_JOB_LOG) AS BARE_ID_BATCH_ID,
          BARE_CD_SOURCE_SYSTEM
   FROM
     (SELECT PORD_POLN_SCLN.SCLN_CD_PLANT_CD AS BARE_CD_PLANT_CD,
             PORD_POLN_SCLN.SCLN_ID_SCHED_LN AS BARE_ID_BARE,
             NVL (TO_NUMBER (TO_CHAR (TO_DATE (P_ELT_DT_JOB_DATE_ELAB, 'YYYYMMDD'), 'J')), -2) AS BARE_ID_TIME_INV_DT,
             PORD_POLN_SCLN.PORD_ID_VEND_SUPPL_CD AS BARE_ID_VEND_ID,
             PORD_POLN_SCLN.PORD_CD_SUPPL_CD AS BARE_CD_VENDOR,
             PORD_POLN_SCLN.POLN_ID_MAMD_PART_NBR AS BARE_ID_MTRL_MATERIAL,
             PORD_POLN_SCLN.POLN_CD_PART_NBR AS BARE_CD_MATERIAL,
             CASE PORD_POLN_SCLN.POLN_CD_ITM_CAT
                 WHEN '0' THEN 'BUY'
                 WHEN '3' THEN 'SUBCONTRACTED'
             END AS BARE_CD_MATERIAL_PURCH_TP,
             PORD_POLN_SCLN.POLN_ID_MASP_MAT_SUPP_REL AS BARE_ID_MASP_MAT_SUPP_REL,
             NVL (TO_NUMBER (TO_CHAR (PORD_POLN_SCLN.SCLN_DT_REQ_DLVR_DT, 'J')), -2) AS BARE_ID_TIME_REQ_DLVR_DT,
             PORD_POLN_SCLN.PORD_CD_PURCH_ORG_CD AS BARE_CD_PURCH_ORG_CD,
             PORD_POLN_SCLN.POLN_CD_INFO_REC_CAT AS BARE_CD_INFO_REC_CAT,
             PORD_POLN_SCLN.PORD_CD_PURCH_ORD AS BARE_CD_PURCH_ORD,
             PORD_POLN_SCLN.POLN_CD_PURCH_ORD_LN AS BARE_CD_PURCH_ORD_LN,
             COUNT (PORD_POLN_SCLN.SCLN_CD_SEQ_ID) OVER (PARTITION BY PORD_POLN_SCLN.PORD_CD_PURCH_ORD,
                                                                      PORD_POLN_SCLN.POLN_CD_PURCH_ORD_LN) AS BARE_QT_TOTAL_ORD_PAST,
                                                        PORD_POLN_SCLN.POLN_QT_REQ_QTY AS BARE_QT_POLN_REQ_QTY,
                                                        PORD_POLN_SCLN.POLN_QT_CUM_QTY AS BARE_QT_POLN_CUM_REC_QTY,
                                                        (PORD_POLN_SCLN.POLN_QT_REQ_QTY - PORD_POLN_SCLN.POLN_QT_CUM_QTY) AS BARE_QT_POLN_REM_QTY,
                                                        PORD_POLN_SCLN.SCLN_CD_SEQ_ID AS BARE_CD_SEQ_ID,
                                                        NVL (TO_NUMBER (TO_CHAR (TD_SLPR_SCHED_LN_PROG.MAX_SLPR_DT_RECEPT_DT, 'J')), -2) AS BARE_ID_TIME_LAST_RECEPT_DT,
                                                        NVL (TO_NUMBER (TO_CHAR (TT_OSLN_OPEN_SCHED_LN.OSLN_DT_PURCH_ORD_SHIPM_DT, 'J')), -2) AS BARE_ID_TIME_FIRST_REQ_SHIP_DT,
                                                        NVL (TO_NUMBER (TO_CHAR (TT_OSLN_OPEN_SCHED_LN.OSLN_DT_PURCH_ORD_DLVR_DT, 'J')), -2) AS BARE_ID_TIME_DOD_DT,
                                                        PORD_POLN_SCLN.SCLN_QT_REQ_QTY AS BARE_QT_SCLN_REQ_QTY,
                                                        NVL (TD_SLPR_SCHED_LN_PROG.SUM_SLPR_QT_RCVD_QTY, 0) AS BARE_QT_SCLN_CUM_REC_QTY,
                                                        (PORD_POLN_SCLN.SCLN_QT_REQ_QTY - NVL (TD_SLPR_SCHED_LN_PROG.SUM_SLPR_QT_RCVD_QTY, 0)) AS BARE_QT_SCLN_REM_REQ_QTY,
                                                        TO_DATE (P_ELT_DT_JOB_DATE_ELAB, 'YYYYMMDD') - PORD_POLN_SCLN.SCLN_DT_REQ_DLVR_DT - DDWH01_DW_MA.PKG_CALENDAR.GETNOTWORKINGDAY (P_ELT_CD_PLANT, PORD_POLN_SCLN.SCLN_DT_REQ_DLVR_DT, TO_DATE (P_ELT_DT_JOB_DATE_ELAB, 'YYYYMMDD')) AS BARE_QT_SCLN_DELAY_WRK_DAYS,
                                                        PORD_POLN_SCLN.SCLN_CD_SOURCE_SYSTEM AS BARE_CD_SOURCE_SYSTEM,
                                                        TT_OSLN_OPEN_SCHED_LN.OSLN_CD_RELEASE_NUMBER AS BARE_CD_RELEASE_NUMBER_CSCN,
                                                        NVL (TO_NUMBER (TO_CHAR (TT_OSLN_OPEN_SCHED_LN.OSLN_DT_RELEASE_DATE, 'J')), -2) AS BARE_ID_TIME_RELEASE_DT_CSCN,
                                                        TT_OSLN_OPEN_SCHED_LN.OSLN_DT_RELEASE_DATE AS BARE_DT_RELEASE_DT_CSCN,
                                                        TT_OSLN_OPEN_SCHED_LN.OSLN_QT_REQ_QTY AS BARE_QT_REQ_QTY_CSCN,
                                                        TT_OSLN_OPEN_SCHED_LN.OSLN_QT_CUM_REQ_QTY AS BARE_QT_CUM_REQ_QTY_CSCN,
                                                        TT_OSLN_OPEN_SCHED_LN.OSLN_QT_CUM_REC_QTY AS BARE_QT_CUM_REC_QTY_CSCN,
                                                        TT_OSLN_OPEN_SCHED_LN.OSLN_QT_TRANS_QTY AS BARE_QT_TRANSIT_QTY_CSCN,
                                                        TT_OSLN_OPEN_SCHED_LN.OSLN_QT_CUM_PUR_QTY AS BARE_QT_CUM_PUR_QTY_CSCN,
                                                        TT_OSLN_OPEN_SCHED_LN.OSLN_QT_BALANCE_QTY AS BARE_QT_BALANCE_QTY_CSCN,
                                                        TT_OSLN_OPEN_SCHED_LN.OSLN_CD_LAST_REC_PACKLIST AS BARE_CD_LAST_REC_PACKLIST_CSCN,
                                                        TT_OSLN_OPEN_SCHED_LN.OSLN_CD_LAST_ASN_PACKLIST AS BARE_CD_LAST_ASN_PACKLIST_CSCN,
                                                        TT_OSLN_OPEN_SCHED_LN.OSLN_CD_LAST_PICKUP_REQID AS BARE_CD_LAST_PICKUP_REQID_CSCN
      FROM
        (SELECT PORD_CD_PLANT_CD,
                PORD_ID_PURCH_ORD,
                POLN_ID_PORD_PURCH_ORD,
                POLN_ID_PURCH_ORD_LN,
                PORD_CD_PURCH_ORD,
                POLN_CD_PURCH_ORD,
                POLN_CD_PURCH_ORD_LN,
                PORD_CD_PURCH_ORG_CD,
                POLN_CD_INFO_REC_CAT,
                PORD_ID_VEND_SUPPL_CD,
                PORD_CD_SUPPL_CD,
                POLN_ID_MAMD_PART_NBR,
                POLN_CD_PART_NBR,
                POLN_QT_REQ_QTY,
                POLN_CD_ITM_CAT,
                POLN_ID_MASP_MAT_SUPP_REL,
                NVL (POLN_QT_CUM_QTY, 0) POLN_QT_CUM_QTY,
                SCLN_CD_PLANT_CD,
                SCLN_ID_SCHED_LN,
                SCLN_CD_SEQ_ID,
                SCLN_QT_REQ_QTY,
                NVL (SCLN_QT_CUM_RCVD_QTY, 0) SCLN_QT_CUM_RCVD_QTY,
                SCLN_ID_BATCH_ID,
                SCLN_CD_SOURCE_SYSTEM,
                SCLN_ID_POLN_PURCH_ORD,
                SCLN_DT_REQ_DLVR_DT
         FROM DDWH01_DW_MA.TT_PORD_PURCH_ORD,
              DDWH01_DW_MA.TD_POLN_PURCH_ORD_LN,
              DDWH01_DW_MA.TD_SCLN_SCHED_LN
         WHERE PORD_CD_PLANT_CD = P_ELT_CD_PLANT
           AND POLN_CD_PLANT_CD = P_ELT_CD_PLANT
           AND SCLN_CD_PLANT_CD = P_ELT_CD_PLANT
           AND POLN_ID_PORD_PURCH_ORD = PORD_ID_PURCH_ORD
           AND SCLN_ID_POLN_PURCH_ORD = POLN_ID_PURCH_ORD_LN
           AND PORD_FL_LOGICAL_STATUS = '1'
           AND POLN_FL_LOGICAL_STATUS = '1'
           AND POLN_FL_CLOSE_MARK = '0'
           AND SCLN_FL_CLOSE_MARK = '0'
           AND SCLN_FL_LOGICAL_STATUS = '1'
           AND SCLN_DT_REQ_DLVR_DT <= TO_DATE (P_ELT_DT_JOB_DATE_ELAB, 'YYYYMMDD')
           AND SCLN_FL_CLOSE_MARK = '0'
           AND SCLN_QT_REQ_QTY > 0 ) PORD_POLN_SCLN,

        (SELECT SLPR_CD_PURCH_ORD,
                SLPR_CD_PURCH_ORD_LN,
                SLPR_CD_SCHED_LN_ID,
                SLPR_CD_MAT_DOC_ID,
                SLPR_ID_SCLN_SCHED_LN,
                SLPR_ID_SCHED_LN_PROG,
                SLPR_DT_RECEPT_DT,
                MAX_SLPR_DT_RECEPT_DT,
                SLPR_QT_RCVD_QTY,
                SUM_SLPR_QT_RCVD_QTY
         FROM
           (SELECT ROW_NUMBER () OVER (PARTITION BY SLPR_CD_PURCH_ORD,
                                                    SLPR_CD_PURCH_ORD_LN,
                                                    SLPR_CD_SCHED_LN_ID
                                       ORDER BY SLPR_CD_MAT_DOC_ID) AS COUNTER,
                                      SLPR_CD_PURCH_ORD,
                                      SLPR_CD_PURCH_ORD_LN,
                                      SLPR_CD_SCHED_LN_ID,
                                      SLPR_CD_MAT_DOC_ID,
                                      SLPR_ID_SCLN_SCHED_LN,
                                      SLPR_ID_SCHED_LN_PROG,
                                      SLPR_DT_RECEPT_DT,
                                      MAX (SLPR_DT_RECEPT_DT) OVER (PARTITION BY SLPR_CD_PURCH_ORD,
                                                                                 SLPR_CD_PURCH_ORD_LN,
                                                                                 SLPR_CD_SCHED_LN_ID) AS MAX_SLPR_DT_RECEPT_DT,
                                                                   SLPR_QT_RCVD_QTY,
                                                                   SUM (SLPR_QT_RCVD_QTY) OVER (PARTITION BY SLPR_CD_PURCH_ORD,
                                                                                                             SLPR_CD_PURCH_ORD_LN,
                                                                                                             SLPR_CD_SCHED_LN_ID) AS SUM_SLPR_QT_RCVD_QTY
            FROM DDWH01_DW_MA.TD_SLPR_SCHED_LN_PROG
            WHERE SLPR_CD_PLANT_CD = P_ELT_CD_PLANT
              AND SLPR_DT_RECEPT_DT <= TO_DATE (P_ELT_DT_JOB_DATE_ELAB, 'YYYYMMDD') )
         WHERE COUNTER = 1 ) TD_SLPR_SCHED_LN_PROG,

        (SELECT OSLN_CD_PURCH_ORD,
                OSLN_CD_PURCH_ORD_LN,
                OSLN_CD_PART_NBR,
                OSLN_DT_PURCH_ORD_SHIPM_DT,
                OSLN_DT_PURCH_ORD_DLVR_DT,
                OSLN_ID_OPEN_SCHED_LN,
                OSLN_CD_RELEASE_NUMBER,
                OSLN_DT_RELEASE_DATE,
                OSLN_QT_REQ_QTY,
                OSLN_QT_CUM_REQ_QTY,
                OSLN_QT_CUM_REC_QTY,
                OSLN_QT_TRANS_QTY,
                OSLN_QT_CUM_PUR_QTY,
                OSLN_QT_BALANCE_QTY,
                OSLN_CD_LAST_REC_PACKLIST,
                OSLN_CD_LAST_ASN_PACKLIST,
                OSLN_CD_LAST_PICKUP_REQID
         FROM DDWH01_DW_MA.TT_OSLN_OPEN_SCHED_LN
         WHERE OSLN_CD_PLANT_CD = P_ELT_CD_PLANT ) TT_OSLN_OPEN_SCHED_LN
      WHERE 1 = 1
        AND TD_SLPR_SCHED_LN_PROG.SLPR_ID_SCLN_SCHED_LN (+) = PORD_POLN_SCLN.SCLN_ID_SCHED_LN
        AND TT_OSLN_OPEN_SCHED_LN.OSLN_CD_PURCH_ORD (+) = PORD_POLN_SCLN.PORD_CD_PURCH_ORD
        AND TT_OSLN_OPEN_SCHED_LN.OSLN_CD_PART_NBR (+) = PORD_POLN_SCLN.POLN_CD_PART_NBR
        AND TT_OSLN_OPEN_SCHED_LN.OSLN_DT_PURCH_ORD_DLVR_DT (+) = PORD_POLN_SCLN.SCLN_DT_REQ_DLVR_DT
        AND PORD_POLN_SCLN.POLN_CD_PART_NBR IS NOT NULL )
   WHERE BARE_QT_SCLN_CUM_REC_QTY < BARE_QT_SCLN_REQ_QTY ) QRY