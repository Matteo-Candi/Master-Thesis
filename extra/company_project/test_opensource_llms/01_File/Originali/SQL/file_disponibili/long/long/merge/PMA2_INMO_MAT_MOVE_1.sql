MERGE INTO DDWH02_DM_MA.TFCT_INMO_MAT_MOVE TRG USING
  (SELECT CASE
              WHEN INMO_FL_LOGICAL_STATUS = '1' THEN 'M'
              ELSE 'D'
          END CONTROL_FIELD,
          TD_INMO_MAT_MOVE.INMO_CD_PLANT_CD,
          TD_INMO_MAT_MOVE.INMO_ID_MAT_MOVE,
          INMO_CD_MOV_SRC,
          INMO_CD_MOV_ID,
          INMO_ID_STMD_SITE,
          INMO_CD_SITE,
          INMO_ID_MAMD_PART_NBR,
          INMO_CD_PART_NBR,
          INMO_ID_WHMR_WH_MAT_REQ,
          INMO_CD_WHMR_TP,
          INMO_CD_WHMR_ORD_NBR,
          INMO_CD_WHMR_ORD_NBR_LN,
          INMO_ID_INDN_INB_DLVR_NT,
          INMO_CD_DLVR_NOTE,
          INMO_CD_DLVR_NOTE_LN,
          INMO_ID_MTMD_MOV_TP,
          INMO_CD_MOV_TP,
          INMO_ID_MSMD_MOV_SUBTP,
          INMO_CD_MOV_SUBTP,
          NVL (TO_NUMBER (TO_CHAR (INMO_DT_MOV_CREAT_DT, 'J')), -2) AS INMO_ID_TIME_MOV_CREAT_DT,
          INMO_DT_MOV_CREAT_DT,
          NVL (TO_NUMBER (TO_CHAR (INMO_DT_MOV_STR_EXEC_DT, 'J')), -2) AS INMO_ID_TIME_MOV_STR_EXEC_DT,
          INMO_DT_MOV_STR_EXEC_DT,
          NVL (TO_NUMBER (TO_CHAR (INMO_DT_MOV_END_EXEC_DT, 'J')), -2) AS INMO_ID_TIME_MOV_END_EXEC_DT,
          INMO_DT_MOV_END_EXEC_DT,
          DDWH01_DW_MA.PKG_CALENDAR.GETAGE (NVL (INMO_DT_MOV_END_EXEC_DT, TO_DATE (P_ELT_DT_JOB_DATE_ELAB||' 23:59:59', 'YYYYMMDD HH24:MI:SS')), INMO_DT_MOV_CREAT_DT, INMO_NT_AGE) AS INMO_NR_AGING,
          INMO_ID_SUMD_MOV_STU,
          INMO_CD_MOV_STU,
          INMO_CD_TASK_ID,
          INMO_CD_ORIG_TASK_ID,
          INMO_QT_EXPC_QTY,
          INMO_QT_CONF_QTY,
          INMO_CD_CONT_SRC,
          INMO_ID_BTMD_CONT_SRC_TP,
          INMO_CD_CONT_SRC_TP,
          INMO_CD_CONT_DEST,
          INMO_ID_BTMD_CONT_DEST_TP,
          INMO_CD_CONT_DEST_TP,
          INMO_CD_BIN_SRC,
          INMO_CD_BIN_SECT_SRC,
          INMO_CD_BIN_DEST,
          INMO_CD_BIN_SECT_DEST,
          INMO_ID_BTMD_BIN_SRC_TP,
          INMO_CD_BIN_SRC_TP,
          INMO_ID_BTMD_BIN_DEST_TP,
          INMO_CD_BIN_DEST_TP,
          INMO_ID_ATMD_BIN_SRC_AREA,
          INMO_CD_BIN_SRC_AREA,
          INMO_ID_ATMD_BIN_DEST_AREA,
          INMO_CD_BIN_DEST_AREA,
          INMO_CD_SRC_BUILDING,
          INMO_CD_SRC_LOC,
          INMO_ID_LTMD_SRC_LOC_TP,
          INMO_CD_SRC_LOC_TP,
          INMO_CD_DEST_BUILDING,
          INMO_CD_DEST_LOC,
          INMO_ID_LTMD_DEST_LOC_TP,
          INMO_CD_DEST_LOC_TP,
          INMO_CD_USER_ID,
          INMO_CD_USER_WKST_ID,
          INMO_ID_RTMD_RES_TP,
          INMO_CD_RES_TP,
          INMO_NT_AGE,
          INMO_ID_MUMD_MAT_STU,
          INMO_CD_MAT_STU,
          INMO_ID_VHMD_VAN,
          INMO_CD_VAN,
          INMO_ID_PROP_PROD_ORD_OP,
          INMO_ID_PLMD_WCTR_CD,
          INMO_CD_EFF_ORD,
          INMO_CD_WCTR_CD,
          INMO_CD_OP,
          NVL (P_ELT_ID_BATCH, N_ELT_ID_JOB_LOG) AS INMO_ID_BATCH_ID,
          INMO_CD_SOURCE_SYSTEM
   FROM DDWH01_DW_MA.TD_INMO_MAT_MOVE
   WHERE 1=1
     AND TD_INMO_MAT_MOVE.INMO_CD_PLANT_CD = P_ELT_CD_PLANT
     AND INMO_CD_MOV_SRC NOT IN ('FOR')
     AND INMO_CD_MOV_TP NOT IN ('MSK',
                                'MSU',
                                'EVC')
     AND INMO_ID_BATCH_ID >
       (SELECT ADWH01_ELT.MA_FUNC_GET_LAST_BATCH_ID (VC_ELT_CD_JOB_NAME, P_ELT_DT_JOB_DATE_ELAB, P_ELT_CD_PLANT)
        FROM DUAL) ) QRY ON (TRG.INMO_CD_PLANT_CD = QRY.INMO_CD_PLANT_CD
                             AND TRG.INMO_ID_MAT_MOVE = QRY.INMO_ID_MAT_MOVE) WHEN MATCHED THEN
UPDATE
SET TRG.INMO_CD_MOV_SRC= QRY.INMO_CD_MOV_SRC,
    TRG.INMO_CD_MOV_ID= QRY.INMO_CD_MOV_ID,
    TRG.INMO_ID_SITE= QRY.INMO_ID_STMD_SITE,
    TRG.INMO_CD_SITE= QRY.INMO_CD_SITE,
    TRG.INMO_ID_MTRL= QRY.INMO_ID_MAMD_PART_NBR,
    TRG.INMO_CD_PART_NBR= QRY.INMO_CD_PART_NBR,
    TRG.INMO_ID_WHMR_WH_MAT_REQ= QRY.INMO_ID_WHMR_WH_MAT_REQ,
    TRG.INMO_CD_WHMR_TP= QRY.INMO_CD_WHMR_TP,
    TRG.INMO_CD_WHMR_ORD_NBR= QRY.INMO_CD_WHMR_ORD_NBR,
    TRG.INMO_CD_WHMR_ORD_NBR_LN= QRY.INMO_CD_WHMR_ORD_NBR_LN,
    TRG.INMO_ID_INDN_INB_DLVR_NT= QRY.INMO_ID_INDN_INB_DLVR_NT,
    TRG.INMO_CD_DLVR_NOTE= QRY.INMO_CD_DLVR_NOTE,
    TRG.INMO_CD_DLVR_NOTE_LN= QRY.INMO_CD_DLVR_NOTE_LN,
    TRG.INMO_ID_MOTP= QRY.INMO_ID_MTMD_MOV_TP,
    TRG.INMO_CD_MOV_TP= QRY.INMO_CD_MOV_TP,
    TRG.INMO_ID_MSMD= QRY.INMO_ID_MSMD_MOV_SUBTP,
    TRG.INMO_CD_MOV_SUBTP= QRY.INMO_CD_MOV_SUBTP,
    TRG.INMO_ID_TIME_MOV_CREAT_DT= QRY.INMO_ID_TIME_MOV_CREAT_DT,
    TRG.INMO_DT_MOV_CREAT_DT= QRY.INMO_DT_MOV_CREAT_DT,
    TRG.INMO_ID_TIME_MOV_STR_EXEC_DT= QRY.INMO_ID_TIME_MOV_STR_EXEC_DT,
    TRG.INMO_DT_MOV_STR_EXEC_DT= QRY.INMO_DT_MOV_STR_EXEC_DT,
    TRG.INMO_ID_TIME_MOV_END_EXEC_DT= QRY.INMO_ID_TIME_MOV_END_EXEC_DT,
    TRG.INMO_DT_MOV_END_EXEC_DT= QRY.INMO_DT_MOV_END_EXEC_DT,
    TRG.INMO_NR_AGING= QRY.INMO_NR_AGING,
    TRG.INMO_ID_STAT= QRY.INMO_ID_SUMD_MOV_STU,
    TRG.INMO_CD_MOV_STU= QRY.INMO_CD_MOV_STU,
    TRG.INMO_CD_TASK_ID= QRY.INMO_CD_TASK_ID,
    TRG.INMO_CD_ORIG_TASK_ID= QRY.INMO_CD_ORIG_TASK_ID,
    TRG.INMO_QT_EXPC_QTY= QRY.INMO_QT_EXPC_QTY,
    TRG.INMO_QT_CONF_QTY= QRY.INMO_QT_CONF_QTY,
    TRG.INMO_CD_CONT_SRC= QRY.INMO_CD_CONT_SRC,
    TRG.INMO_ID_BINT_CONT_SRC_TP= QRY.INMO_ID_BTMD_CONT_SRC_TP,
    TRG.INMO_CD_CONT_SRC_TP= QRY.INMO_CD_CONT_SRC_TP,
    TRG.INMO_CD_CONT_DEST= QRY.INMO_CD_CONT_DEST,
    TRG.INMO_ID_BINT_CONT_DEST_TP= QRY.INMO_ID_BTMD_CONT_DEST_TP,
    TRG.INMO_CD_CONT_DEST_TP= QRY.INMO_CD_CONT_DEST_TP,
    TRG.INMO_CD_BIN_SRC= QRY.INMO_CD_BIN_SRC,
    TRG.INMO_CD_BIN_SECT_SRC= QRY.INMO_CD_BIN_SECT_SRC,
    TRG.INMO_CD_BIN_DEST= QRY.INMO_CD_BIN_DEST,
    TRG.INMO_CD_BIN_SECT_DEST= QRY.INMO_CD_BIN_SECT_DEST,
    TRG.INMO_ID_BINT_BIN_SRC_TP= QRY.INMO_ID_BTMD_BIN_SRC_TP,
    TRG.INMO_CD_BIN_SRC_TP= QRY.INMO_CD_BIN_SRC_TP,
    TRG.INMO_ID_BINT_BIN_DEST_TP= QRY.INMO_ID_BTMD_BIN_DEST_TP,
    TRG.INMO_CD_BIN_DEST_TP= QRY.INMO_CD_BIN_DEST_TP,
    TRG.INMO_ID_AREA_BIN_SRC_AREA= QRY.INMO_ID_ATMD_BIN_SRC_AREA,
    TRG.INMO_CD_BIN_SRC_AREA= QRY.INMO_CD_BIN_SRC_AREA,
    TRG.INMO_ID_AREA_BIN_DEST_AREA= QRY.INMO_ID_ATMD_BIN_DEST_AREA,
    TRG.INMO_CD_BIN_DEST_AREA= QRY.INMO_CD_BIN_DEST_AREA,
    TRG.INMO_CD_SRC_BUILDING= QRY.INMO_CD_SRC_BUILDING,
    TRG.INMO_CD_SRC_LOC= QRY.INMO_CD_SRC_LOC,
    TRG.INMO_ID_LOTP_SRC_LOC_TP= QRY.INMO_ID_LTMD_SRC_LOC_TP,
    TRG.INMO_CD_SRC_LOC_TP= QRY.INMO_CD_SRC_LOC_TP,
    TRG.INMO_CD_DEST_BUILDING= QRY.INMO_CD_DEST_BUILDING,
    TRG.INMO_CD_DEST_LOC= QRY.INMO_CD_DEST_LOC,
    TRG.INMO_ID_LOTP_DEST_LOC_TP= QRY.INMO_ID_LTMD_DEST_LOC_TP,
    TRG.INMO_CD_DEST_LOC_TP= QRY.INMO_CD_DEST_LOC_TP,
    TRG.INMO_CD_USER_ID= QRY.INMO_CD_USER_ID,
    TRG.INMO_CD_USER_WKST_ID= QRY.INMO_CD_USER_WKST_ID,
    TRG.INMO_ID_RTMD_RES_TP= QRY.INMO_ID_RTMD_RES_TP,
    TRG.INMO_CD_RES_TP= QRY.INMO_CD_RES_TP,
    TRG.INMO_NT_AGE= QRY.INMO_NT_AGE,
    TRG.INMO_ID_LMST_MAT_STU= QRY.INMO_ID_MUMD_MAT_STU,
    TRG.INMO_CD_MAT_STU= QRY.INMO_CD_MAT_STU,
    TRG.INMO_ID_VEHI_VAN= QRY.INMO_ID_VHMD_VAN,
    TRG.INMO_CD_VAN= QRY.INMO_CD_VAN,
    TRG.INMO_ID_PROP_PROD_ORD_OP= QRY.INMO_ID_PROP_PROD_ORD_OP,
    TRG.INMO_ID_PLST_WCTR_CD= QRY.INMO_ID_PLMD_WCTR_CD,
    TRG.INMO_CD_EFF_ORD= QRY.INMO_CD_EFF_ORD,
    TRG.INMO_CD_WCTR_CD= QRY.INMO_CD_WCTR_CD,
    TRG.INMO_CD_OP= QRY.INMO_CD_OP,
    TRG.INMO_ID_BATCH_ID= QRY.INMO_ID_BATCH_ID,
    TRG.INMO_CD_SOURCE_SYSTEM= QRY.INMO_CD_SOURCE_SYSTEM,
    TRG.INMO_DT_INS_ROW= SYSDATE,
    TRG.INMO_DT_UPD_ROW= SYSDATE,
    TRG.INMO_CD_OPERATOR_CODE= 'ETL' WHEN NOT MATCHED THEN
INSERT (INMO_CD_PLANT_CD,
        INMO_ID_MAT_MOVE,
        INMO_CD_MOV_SRC,
        INMO_CD_MOV_ID,
        INMO_ID_SITE,
        INMO_CD_SITE,
        INMO_ID_MTRL,
        INMO_CD_PART_NBR,
        INMO_ID_WHMR_WH_MAT_REQ,
        INMO_CD_WHMR_TP,
        INMO_CD_WHMR_ORD_NBR,
        INMO_CD_WHMR_ORD_NBR_LN,
        INMO_ID_INDN_INB_DLVR_NT,
        INMO_CD_DLVR_NOTE,
        INMO_CD_DLVR_NOTE_LN,
        INMO_ID_MOTP,
        INMO_CD_MOV_TP,
        INMO_ID_MSMD,
        INMO_CD_MOV_SUBTP,
        INMO_ID_TIME_MOV_CREAT_DT,
        INMO_DT_MOV_CREAT_DT,
        INMO_ID_TIME_MOV_STR_EXEC_DT,
        INMO_DT_MOV_STR_EXEC_DT,
        INMO_ID_TIME_MOV_END_EXEC_DT,
        INMO_DT_MOV_END_EXEC_DT,
        INMO_NR_AGING,
        INMO_ID_STAT,
        INMO_CD_MOV_STU,
        INMO_CD_TASK_ID,
        INMO_CD_ORIG_TASK_ID,
        INMO_QT_EXPC_QTY,
        INMO_QT_CONF_QTY,
        INMO_CD_CONT_SRC,
        INMO_ID_BINT_CONT_SRC_TP,
        INMO_CD_CONT_SRC_TP,
        INMO_CD_CONT_DEST,
        INMO_ID_BINT_CONT_DEST_TP,
        INMO_CD_CONT_DEST_TP,
        INMO_CD_BIN_SRC,
        INMO_CD_BIN_SECT_SRC,
        INMO_CD_BIN_DEST,
        INMO_CD_BIN_SECT_DEST,
        INMO_ID_BINT_BIN_SRC_TP,
        INMO_CD_BIN_SRC_TP,
        INMO_ID_BINT_BIN_DEST_TP,
        INMO_CD_BIN_DEST_TP,
        INMO_ID_AREA_BIN_SRC_AREA,
        INMO_CD_BIN_SRC_AREA,
        INMO_ID_AREA_BIN_DEST_AREA,
        INMO_CD_BIN_DEST_AREA,
        INMO_CD_SRC_BUILDING,
        INMO_CD_SRC_LOC,
        INMO_ID_LOTP_SRC_LOC_TP,
        INMO_CD_SRC_LOC_TP,
        INMO_CD_DEST_BUILDING,
        INMO_CD_DEST_LOC,
        INMO_ID_LOTP_DEST_LOC_TP,
        INMO_CD_DEST_LOC_TP,
        INMO_CD_USER_ID,
        INMO_CD_USER_WKST_ID,
        INMO_ID_RTMD_RES_TP,
        INMO_CD_RES_TP,
        INMO_NT_AGE,
        INMO_ID_LMST_MAT_STU,
        INMO_CD_MAT_STU,
        INMO_ID_VEHI_VAN,
        INMO_CD_VAN,
        INMO_ID_PROP_PROD_ORD_OP,
        INMO_ID_PLST_WCTR_CD,
        INMO_CD_EFF_ORD,
        INMO_CD_WCTR_CD,
        INMO_CD_OP,
        INMO_ID_BATCH_ID,
        INMO_CD_SOURCE_SYSTEM,
        INMO_DT_INS_ROW,
        INMO_DT_UPD_ROW,
        INMO_CD_OPERATOR_CODE)
VALUES (QRY.INMO_CD_PLANT_CD, QRY.INMO_ID_MAT_MOVE, QRY.INMO_CD_MOV_SRC, QRY.INMO_CD_MOV_ID, QRY.INMO_ID_STMD_SITE, QRY.INMO_CD_SITE, QRY.INMO_ID_MAMD_PART_NBR, QRY.INMO_CD_PART_NBR, QRY.INMO_ID_WHMR_WH_MAT_REQ, QRY.INMO_CD_WHMR_TP, QRY.INMO_CD_WHMR_ORD_NBR, QRY.INMO_CD_WHMR_ORD_NBR_LN, QRY.INMO_ID_INDN_INB_DLVR_NT, QRY.INMO_CD_DLVR_NOTE, QRY.INMO_CD_DLVR_NOTE_LN, QRY.INMO_ID_MTMD_MOV_TP, QRY.INMO_CD_MOV_TP, QRY.INMO_ID_MSMD_MOV_SUBTP, QRY.INMO_CD_MOV_SUBTP, QRY.INMO_ID_TIME_MOV_CREAT_DT, QRY.INMO_DT_MOV_CREAT_DT, QRY.INMO_ID_TIME_MOV_STR_EXEC_DT, QRY.INMO_DT_MOV_STR_EXEC_DT, QRY.INMO_ID_TIME_MOV_END_EXEC_DT, QRY.INMO_DT_MOV_END_EXEC_DT, QRY.INMO_NR_AGING, QRY.INMO_ID_SUMD_MOV_STU, QRY.INMO_CD_MOV_STU, QRY.INMO_CD_TASK_ID, QRY.INMO_CD_ORIG_TASK_ID, QRY.INMO_QT_EXPC_QTY, QRY.INMO_QT_CONF_QTY, QRY.INMO_CD_CONT_SRC, QRY.INMO_ID_BTMD_CONT_SRC_TP, QRY.INMO_CD_CONT_SRC_TP, QRY.INMO_CD_CONT_DEST, QRY.INMO_ID_BTMD_CONT_DEST_TP, QRY.INMO_CD_CONT_DEST_TP, QRY.INMO_CD_BIN_SRC, QRY.INMO_CD_BIN_SECT_SRC, QRY.INMO_CD_BIN_DEST, QRY.INMO_CD_BIN_SECT_DEST, QRY.INMO_ID_BTMD_BIN_SRC_TP, QRY.INMO_CD_BIN_SRC_TP, QRY.INMO_ID_BTMD_BIN_DEST_TP, QRY.INMO_CD_BIN_DEST_TP, QRY.INMO_ID_ATMD_BIN_SRC_AREA, QRY.INMO_CD_BIN_SRC_AREA, QRY.INMO_ID_ATMD_BIN_DEST_AREA, QRY.INMO_CD_BIN_DEST_AREA, QRY.INMO_CD_SRC_BUILDING, QRY.INMO_CD_SRC_LOC, QRY.INMO_ID_LTMD_SRC_LOC_TP, QRY.INMO_CD_SRC_LOC_TP, QRY.INMO_CD_DEST_BUILDING, QRY.INMO_CD_DEST_LOC, QRY.INMO_ID_LTMD_DEST_LOC_TP, QRY.INMO_CD_DEST_LOC_TP, QRY.INMO_CD_USER_ID, QRY.INMO_CD_USER_WKST_ID, QRY.INMO_ID_RTMD_RES_TP, QRY.INMO_CD_RES_TP, QRY.INMO_NT_AGE, QRY.INMO_ID_MUMD_MAT_STU, QRY.INMO_CD_MAT_STU, QRY.INMO_ID_VHMD_VAN, QRY.INMO_CD_VAN, QRY.INMO_ID_PROP_PROD_ORD_OP, QRY.INMO_ID_PLMD_WCTR_CD, QRY.INMO_CD_EFF_ORD, QRY.INMO_CD_WCTR_CD, QRY.INMO_CD_OP, QRY.INMO_ID_BATCH_ID, QRY.INMO_CD_SOURCE_SYSTEM, SYSDATE, SYSDATE, 'ETL')